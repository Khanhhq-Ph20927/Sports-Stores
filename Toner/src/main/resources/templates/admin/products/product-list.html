<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-layout="vertical" data-topbar="light" data-sidebar="light"
      data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" data-body-image="none">
<head th:replace="admin/fragments/head::head">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.1.0/remixicon.css"
          integrity="sha512-dUOcWaHA4sUKJgO7lxAQ0ugZiWjiDraYNeNJeRKGOIpEq4vroj1DpKcS3jP0K4Js4v6bXk31AAxAxaYt3Oi9xw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body>
<!-- Begin page -->
<div id="layout-wrapper">
    <div th:replace="admin/fragments/header::header"></div>
    <!-- ========== App Menu ========== -->
    <div th:replace="admin/fragments/sidebar::sidebar"></div>
    <!-- Left Sidebar End -->
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Danh Sách Sản Phẩm</h4>
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Sản Phẩm</a></li>
                                    <li class="breadcrumb-item active">Danh Sách Sản Phẩm</li>
                                </ol>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="row p-2">
                                <div class="col-sm-auto">
                                    <div>
                                        <a th:href="@{/api/admin/product/create_product}" class="btn btn-success"
                                           id="addproduct-btn"><i class="ri-add-line align-bottom me-1"></i> Thêm Sản
                                            Phẩm</a>
                                    </div>
                                </div>

                                <div class="col-sm-auto">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Loại Sản Phẩm</label>
                                            <select class="form-select mb-3"
                                                    aria-label=".form-select-lg example"
                                                    id="filter-collections"
                                                    onchange="searchProduct()">
                                                <option value="-1" selected>Tất Cả</option>
                                                <option value="0">Quần</option>
                                                <option value="1">Áo</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Trạng Thái</label>
                                            <select class="form-select mb-3"
                                                    aria-label=".form-select-lg example"
                                                    id="filter-status"
                                                    onchange="searchProduct()">
                                                <option value="-1" selected>Tất Cả</option>
                                                <option value="0">Chưa Mở Bán</option>
                                                <option value="1">Đang Mở Bán</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="form-label">Giá</p>
                                            <div class="formCost d-flex gap-2 align-items-center mb-3">
                                                <input class="form-control form-control-sm" type="text" id="minCost"
                                                       value="0"> <span class="fw-semibold text-muted">to</span> <input
                                                    class="form-control form-control-sm" type="text" id="maxCost"
                                                    value="1000">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm">
                                    <div class="d-flex justify-content-sm-end">
                                        <div class="search-box ms-2">
                                            <input type="text" class="form-control" autocomplete="off"
                                                   id="searchProductList" placeholder="Tìm Kiếm Sản Phẩm..."
                                                   onkeyup="searchProduct()">
                                            <i class="ri-search-line search-icon"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card p-2">
                            <div id="product-list" class="gridjs-border-none mb-4">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th scope="col">Id</th>
                                        <th scope="col">Tên</th>
                                        <th scope="col">Giá</th>
                                        <th scope="col">Danh Mục</th>
                                        <th scope="col">Trạng Thái</th>
                                        <th scope="col">Action</th>
                                    </tr>
                                    </thead>
                                    <tbody style="font-weight: normal" id="list_Product">
                                    </tbody>
                                </table>
                                <div class="row">
                                    <div class="col-lg-3"></div>
                                    <div class="col-lg-1"></div>
                                    <div class="col-lg-4">
                                        <nav aria-label="Page navigation example">
                                            <ul class="pagination justify-content-center" id="pagination">
                                            </ul>
                                        </nav>
                                    </div>
                                    <div class="col-lg-3"></div>
                                    <div class="col-lg-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end card -->
            </div>
            <div class="modal" id="myModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Chi Tiết Sản Phẩm</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="update-form" action="" class="my-form" method="post" th:object="${product}">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0 me-3">
                                                <div class="avatar-sm">
                                                    <div class="avatar-title rounded-circle bg-light text-primary fs-20">
                                                        <i class="bi bi-list-ul"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-1">General Information</h5>
                                                <p class="text-muted mb-0">Fill all information below.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row ">
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label" for="product-name-input">Tên Sản
                                                        Phẩm</label>
                                                    <input type="text" class="form-control" id="product-name-input"
                                                           placeholder="Enter product name" th:name="tenSP">
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Nhà Cung Cấp</label>
                                                    <select class="form-select mb-3"
                                                            aria-label=".form-select-lg example"
                                                            id="product-brand-input" th:name="ncc">
                                                        <option selected value="-1">Open this select menu</option>
                                                        <option value="1">Nhà Cung Cấp A</option>
                                                        <option value="2">Nhà Cung Cấp B</option>
                                                        <option value="3">Nhà Cung Cấp C</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- end row -->

                                        <div class="row">
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Danh Mục</label>
                                                    <select class="form-select mb-3"
                                                            aria-label=".form-select-lg example"
                                                            id="product-collections-input" th:name="danhMuc">
                                                        <option selected value="-1">Open this select menu</option>
                                                        <option value="0">Áo</option>
                                                        <option value="1">Quần</option>
                                                    </select>
                                                </div>
                                                <!--                                                    <div class="alert alert-danger" th:if="${errorCollections != null}" th:text="${errorCollections}"></div>-->
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Trang Thái</label>
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="radio" id="radioStatus1"
                                                               value="0" th:name="trangThai">
                                                        <label class="form-check-label" for="radioStatus1">
                                                            Chưa Mở Bán
                                                        </label>
                                                        <br>
                                                        <input class="form-check-input" type="radio" id="radioStatus2"
                                                               value="1" th:name="trangThai">
                                                        <label class="form-check-label" for="radioStatus2">
                                                            Đang Mở Bán
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end row-->

                                        <div class="row">
                                            <div class="col-lg-6">
                                                <div class="md-3">
                                                    <label class="form-label">Thương Hiệu</label>
                                                    <select class="form-select mb-3"
                                                            aria-label=".form-select-lg example"
                                                            id="product-provider-input" th:name="thieu">
                                                        <option selected value="-1">Open this select menu</option>
                                                        <option value="1">Local Brand 1</option>
                                                        <option value="2">Local Brand 2</option>
                                                        <option value="3">Local Brand 3</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label" for="product-price-input">Giá</label>
                                                    <div class="input-group has-validation mb-3">
                                                        <span class="input-group-text"
                                                              id="product-price-addon">VND</span>
                                                        <input type="text" class="form-control" id="product-price-input"
                                                               placeholder="Enter price" aria-label="Price"
                                                               aria-describedby="product-price-addon" th:name="donGia"
                                                               required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- end col -->
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Đóng
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="showConfirmPopup()">
                                            Lưu
                                        </button>
                                    </div>
                                    <!-- end row -->
                                </div>
                            </form>
                        </div>
                        <!-- end col -->
                    </div>
                    <!-- end row -->
                </div>
            </div>
            <!--        end modal-->
        </div>
    </div>
</div>
<!-- End Page-content -->
</div>
<!-- end main content-->
</div>
<!-- END layout-wrapper -->
<div th:replace="admin/fragments/chat::chat"></div>
<div th:replace="admin/fragments/themeSettings::themeSettings"></div>
<div th:replace="admin/fragments/script::script"></div>
</body>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">

    window.onload = function () {
        loadPage(0);
    }

    function deleteProduct(productId) {
        swal.fire({
            title: "Do you want to delete this product?",
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: "Delete",
            denyButtonText: `Don't Delete`
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/api/admin/product/delete/' + productId, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.status === 200) {
                            swal.fire("Products are deleted!", "", "success").then((result) => {
                                if (result.isConfirmed) {
                                    window.location.reload();
                                }
                            });
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        swal.fire("Error Deleting Product!", "", "error")
                    });
            } else if (result.isDenied) {
                swal.fire("Products are not deleted!", "", "info");
            }
        });
    }

    function detailProduct(productId) {
        fetch('/api/admin/product/detail/' + productId, {
            method: 'GET'
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            console.log(data);
            document.getElementById('product-name-input').value = data.tenSP;
            document.getElementById('product-brand-input').value = data.ncc.id;
            document.getElementById('product-collections-input').value = data.danhMuc;
            document.getElementById('product-provider-input').value = data.thieu.id;
            document.getElementById('product-price-input').value = data.donGia;
            document.getElementById('update-form').action = '/api/admin/product/update/' + productId;
            if (data.trangThai === 0) {
                document.getElementById('radioStatus1').checked = true;
            } else if (data.trangThai === 1) {
                document.getElementById('radioStatus2').checked = true;
            }

            $('#myModal').modal('show');
        })
            .catch(error => console.error('Error:', error));
    }

    function showConfirmPopup() {
        swal.fire({
            title: "Do you want to save the changes?",
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: "Save",
            denyButtonText: `Don't save`
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('update-form').submit();
                loadPage(0);
            }
            // else if (result.isDenied) {
            //     // swal.fire("Changes are not saved", "", "info");
            // }
        });
    }

    async function loadPage(pageNumber) {
        var url = "/api/admin/product/page/search/" + pageNumber + "/" + "null";
        const response = await fetch(url, {
            method: 'GET'
        });
        var result = await response.json();
        console.log(result);
        var list = result.content;
        var totalPage = result.totalPages;
        var number = result.number;
        var main = '';
        for (i = 0; i < list.length; i++) {
            var trangThaiBadge = (list[i].trangThai == 0) ? '<span class="badge bg-success">Chưa Mở Bán</span>' : '<span class="badge bg-success">Đang Mở Bán</span>';
            main += `<tr >
                            <td scope="row">${list[i].maSP}</td>
                            <td scope="row">${list[i].tenSP}</td>
                            <td scope="row">${formatMoney(list[i].donGia)}</td>
                            <td scope="row">${list[i].danhMuc == 0 ? 'Áo' : 'Quần'}</td>
                            <td>${trangThaiBadge}</td>
                            <td>
                                <div class="hstack gap-3 flex-warp">
                                <div onclick="detailProduct(${list[i].id})"
                                     class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                                 </div>
                            </td>
                     </tr>`
        }
        document.getElementById("list_Product").innerHTML = main;
        var currentPage = `
            <li class="page-item">
                    <button class="page-link" aria-label="Previous" onclick="loadPage(${number - 1 === 0 ? totalPage : number - 1})"><span aria-hidden="true">&laquo;</span></button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="loadPage(0)">1</button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="loadPage(1)">2</button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="loadPage(2)">3</button>
            </li>
            <li class="page-item">
                    <button class="page-link" aria-label="Next" onclick="loadPage(${number + 1 === totalPage ? 0 : number + 1})">
                       <span aria-hidden="true">&raquo;</span>
                     </button>
            </li>
        `;
        document.getElementById("pagination").innerHTML = currentPage;
    }

    function formatMoney(money) {
        const VND = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });
        return VND.format(money);
    }

    async function searchProduct(pageNumber) {
        var keyword = document.getElementById("searchProductList").value.trim().toLowerCase();
        var status = document.getElementById("filter-status").value;
        var collection = document.getElementById("filter-collections").value;
        var url;
        if (pageNumber === undefined && keyword === '') {
            url = "/api/admin/product/page/search/" + 0 + "/" + "null";
            console.log(url);
        }
        else if (pageNumber === undefined && keyword !== '') {
            url = "/api/admin/product/page/search/" + 0 + "/" + keyword;
            console.log(url);
        }
        else if (pageNumber !== undefined && keyword !== '') {
            url = "/api/admin/product/page/search/" + pageNumber + "/" + keyword;
            console.log(url);
        }
        else if (pageNumber === undefined && keyword === '' && (status !== -1 || collection !== -1)) {
            url = "/api/admin/product/page/" + "null" + "/" + 0 + "/" + status + "/" + collection;
            console.log(url);
        }
        else if (pageNumber !== undefined && keyword === '' && (status !== -1 || collection !== -1)) {
            url = "/api/admin/product/page/" + "null" + "/" + pageNumber + "/" + status + "/" + collection;
            console.log(url);
        }
        else if (pageNumber !== undefined && (status !== -1 || collection !== -1) && keyword !== '') {
            url = "/api/admin/product/page/" + keyword + "/" + pageNumber + "/" + status + "/" + collection;
            console.log(url);
        }
        const response = await fetch(url, {
            method: 'GET'
        });
        var result = await response.json();
        console.log(result);
        var list = result.content;
        var totalPage = result.totalPages;
        var number = result.number;
        var main = '';
        for (i = 0; i < list.length; i++) {
            var trangThaiBadge = (list[i].trangThai == 0) ? '<span class="badge bg-success">Chưa Mở Bán</span>' : '<span class="badge bg-success">Đang Mở Bán</span>';
            main += `<tr >
                            <td scope="row">${list[i].maSP}</td>
                            <td scope="row">${list[i].tenSP}</td>
                            <td scope="row">${formatMoney(list[i].donGia)}</td>
                            <td scope="row">${list[i].danhMuc == 0 ? 'Quần' : 'Áo'}</td>
                            <td>${trangThaiBadge}</td>
                            <td>
                                <div class="hstack gap-3 flex-warp">
                                <div onclick="detailProduct(${list[i].id})"
                                     class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                                 </div>
                            </td>
                     </tr>`
        }
        document.getElementById("list_Product").innerHTML = main;
        var currentPage = `
            <li class="page-item">
                    <button class="page-link" aria-label="Previous" onclick="searchProduct(${number - 1 < 0 ? totalPage - 1 : number - 1})"><span aria-hidden="true">&laquo;</span></button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="searchProduct(0)">1</button>
            </li>
            <li class="page-item">
                    <button class="page-link">...</button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="searchProduct(${totalPage - 1})">${totalPage}</button>
            </li>
            </li>
            <li class="page-item">
                    <button class="page-link" aria-label="Next" onclick="searchProduct(${number + 1 === totalPage ? 0 : number + 1})">
                       <span aria-hidden="true">&raquo;</span>
                     </button>
            </li>
        `;
        document.getElementById("pagination").innerHTML = currentPage;
    }
</script>
<script th:if="${updateSuccess == true}">
    swal.fire("Changes have been Saved!", "", "success");
</script>
<script th:if="${updateFailure == false}">
    swal.fire("Changes have not been saved!", "", "error");
</script>
</html>