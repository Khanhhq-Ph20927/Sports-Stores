<!doctype html>
<html data-bs-theme="light" data-footer="dark" lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="client/fragments/head::head"></head>
<body>
<div th:replace="client/fragments/header::header"></div>
<!-- Modal -->
<div aria-hidden="true" class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded">
            <div class="modal-header p-3">
                <div class="position-relative w-100">
                    <input autocomplete="off" class="form-control form-control-lg border-2" id="search-options"
                           placeholder="Search for Toner..." type="text" value="">
                    <span class="bi bi-search search-widget-icon fs-17"></span>
                    <a class="search-widget-icon fs-14 link-secondary text-decoration-underline search-widget-icon-close d-none"
                       href="javascript:void(0);"
                       id="search-close-options">Clear</a>
                </div>
            </div>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0 overflow-hidden" id="search-dropdown">

                <div class="dropdown-head rounded-top">
                    <div class="p-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="m-0 fs-14 text-muted fw-semibold"> RECENT SEARCHES </h6>
                            </div>
                        </div>
                    </div>

                    <div class="dropdown-item bg-transparent text-wrap">
                        <a class="btn btn-soft-secondary btn-sm btn-rounded" href="index.html">how to setup <i
                                class="mdi mdi-magnify ms-1 align-middle"></i></a>
                        <a class="btn btn-soft-secondary btn-sm btn-rounded" href="index.html">buttons <i
                                class="mdi mdi-magnify ms-1 align-middle"></i></a>
                    </div>
                </div>

                <div class="pe-2 ps-3 my-3" data-simplebar style="max-height: 300px;">
                    <div class="list-group list-group-flush border-dashed">
                        <div class="notification-group-list">
                            <h5 class="text-overflow text-muted fs-13 mb-2 mt-3 text-uppercase notification-title">Apps
                                Pages</h5>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);"><i
                                    class="bi bi-speedometer2 me-2"></i> <span>Analytics Dashboard</span></a>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);"><i
                                    class="bi bi-filetype-psd me-2"></i> <span>Toner.psd</span></a>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);"><i
                                    class="bi bi-ticket-detailed me-2"></i> <span>Support Tickets</span></a>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);"><i
                                    class="bi bi-file-earmark-zip me-2"></i> <span>Toner.zip</span></a>
                        </div>

                        <div class="notification-group-list">
                            <h5 class="text-overflow text-muted fs-13 mb-2 mt-3 text-uppercase notification-title">
                                Links</h5>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);"><i
                                    class="bi bi-link-45deg me-2 align-middle"></i> <span>www.themesbrand.com</span></a>
                        </div>

                        <div class="notification-group-list">
                            <h5 class="text-overflow text-muted fs-13 mb-2 mt-3 text-uppercase notification-title">
                                People</h5>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);">
                                <div class="d-flex align-items-center">
                                    <img alt="" class="avatar-xs rounded-circle flex-shrink-0 me-2"
                                         src="../assets/images/users/avatar-1.jpg">
                                    <div>
                                        <h6 class="mb-0">Ayaan Bowen</h6>
                                        <span class="fs-12 text-muted">React Developer</span>
                                    </div>
                                </div>
                            </a>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);">
                                <div class="d-flex align-items-center">
                                    <img alt="" class="avatar-xs rounded-circle flex-shrink-0 me-2"
                                         src="../assets/images/users/avatar-7.jpg">
                                    <div>
                                        <h6 class="mb-0">Alexander Kristi</h6>
                                        <span class="fs-12 text-muted">React Developer</span>
                                    </div>
                                </div>
                            </a>
                            <a class="list-group-item dropdown-item notify-item" href="javascript:void(0);">
                                <div class="d-flex align-items-center">
                                    <img alt="" class="avatar-xs rounded-circle flex-shrink-0 me-2"
                                         src="../assets/images/users/avatar-5.jpg">
                                    <div>
                                        <h6 class="mb-0">Alan Carla</h6>
                                        <span class="fs-12 text-muted">React Developer</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- removeItemModal -->
<div aria-hidden="true" class="modal fade zoomIn" id="removeItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" id="close-modal"
                        type="button"></button>
            </div>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon colors="primary:#f7b84b,secondary:#f06548" src="https://cdn.lordicon.com/gsqxdxog.json"
                               style="width:100px;height:100px" trigger="loop"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>Are you sure ?</h4>
                        <p class="text-muted mx-4 mb-0">Are you sure you want to remove this product ?</p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button class="btn w-sm btn-light" data-bs-dismiss="modal" type="button">Close</button>
                    <button class="btn w-sm btn-danger" id="remove-product" type="button">Yes, Delete It!</button>
                </div>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- end modal -->
<div th:replace="client/fragments/chat::chat"></div>
<section class="trend-fashion-home">
    <div class="container-fluid container-custom">
        <div class="row g-0">
            <div class="col-lg-4">
                <div class="home-widgets card card-height-100 border-0 rounded-end-0"
                     style="background-image: url('../assets/images/fashion/img-3.png');background-size: cover;">
                    <div class="card-body"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-height-100 border-0 rounded-0 bg-info-subtle">
                    <div class="card-body px-4 px-lg-5 text-center d-flex align-items-center">
                        <div>
                            <h3 class="text-capitalize lh-base mb-2">The World Most suitable <span class="ff-secondary">Fashion</span>
                                Collection</h3>
                            <p class="fs-16 mb-4">Fashion Academy recommends 10 to 12 styles for your first collection.
                                As for how many items to produce within each style frame, test out the waters first.</p>
                            <button class="btn btn-info btn-hover rounded-0" type="button">Shop Now <i
                                    class="bi bi-bag align-baseline ms-1"></i></button>
                        </div>
                    </div>
                </div>
            </div><!--end col-->
            <div class="col-lg-4">
                <div class="card home-widgets card-height-100 border-0 rounded-start-0"
                     style="background-image: url('../assets/images/fashion/img-5.png');background-size: cover;">
                    <div class="card-body"></div>
                </div>
            </div>
        </div><!--end row-->
    </div><!--end container-fluid-->
</section>
<!--end home-->
<section class="section">
    <div class="container-fluid container-custom">
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="section-content text-center mb-5">
                    <p class="fs-20">Top sale in this week</p>
                    <h2 class="title fw-normal text-capitalize">You are in <span class="fw-semibold">new arrivals</span>
                    </h2>
                </div>
            </div><!--end col-->
        </div><!--end row-->
        <div class="row row-cols-xxl-4 row-cols-lg-4 row-cols-md-2 row-cols-1" id="productList">
        </div><!--end row-->
        <div class="text-center mt-4">
            <button class="btn btn-info rounded-0 btn-load" id="productLoadMore" onclick="nextPageProduct()"
                    type="button">
                    <span class="d-flex align-items-center">
                        <span class="flex-grow-1 me-2">
                            See All
                        </span>
                        <span class="spinner-border flex-shrink-0" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </span>
            </button>
        </div>
    </div><!--end container-->
</section>
<!--end product-->

<!--start why Choose-->
<section class="section py-0">
    <div class="container-fluid container-custom">
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="section-content text-center mb-5 pb-3">
                    <h2 class="title fw-normal"><span>Why <span class="fw-semibold">Shop</span> with us?</h2>
                </div>
            </div><!--end col-->
        </div><!--end row-->
        <div class="row">
            <div class="col-lg-3">
                <div class="card border-0 text-center">
                    <div class="card-body">
                        <div class="avatar-md mx-auto mb-4">
                            <div class="avatar-title bg-light text-reset fs-2 rounded">
                                <i class="bi bi-shield-check"></i>
                            </div>
                        </div>
                        <h5>Products Quality</h5>
                        <p class="text-muted mb-0">Product quality refers to how well a product satisfies customer
                            needs, serves its purpose and meets industry standards. </p>
                    </div>
                </div>
            </div><!--end col-->
            <div class="col-lg-3">
                <div class="card border-0 text-center">
                    <div class="card-body">
                        <div class="avatar-md mx-auto mb-4">
                            <div class="avatar-title bg-light text-reset fs-2 rounded">
                                <i class="bi bi-truck"></i>
                            </div>
                        </div>
                        <h5>Fast & Free Shipping</h5>
                        <p class="text-muted mb-0">The cheapest way to ship a package will depend on factors such as
                            package size and weight, as well as distance and delivery speed.</p>
                    </div>
                </div>
            </div><!--end col-->
            <div class="col-lg-3">
                <div class="card border-0 text-center">
                    <div class="card-body">
                        <div class="avatar-md mx-auto mb-4">
                            <div class="avatar-title bg-light text-reset fs-2 rounded">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                        </div>
                        <h5>Payment Security</h5>
                        <p class="text-muted mb-0">Payment security refers to providing rules, regulations, and security
                            measures to protect a customer or partner's privacy.</p>
                    </div>
                </div>
            </div><!--end col-->
            <div class="col-lg-3">
                <div class="card border-0 text-center">
                    <div class="card-body">
                        <div class="avatar-md mx-auto mb-4">
                            <div class="avatar-title bg-light text-reset fs-2 rounded">
                                <i class="bi bi-house-door"></i>
                            </div>
                        </div>
                        <h5>Global Warehouse</h5>
                        <p class="text-muted mb-0">An international warehouse is a warehouse that's set up
                            internationally, typically located in a global trade Houston, or Hong Kong.</p>
                    </div>
                </div>
            </div><!--end col-->
        </div><!--end row-->
    </div><!--end container-fluid-->
</section>
<!--end why Choose-->
<div th:replace="client/fragments/footer::footer"></div>
<div th:replace="client/fragments/script::script"></div>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script>

    const Toast = swal.mixin({
        toast: true,
        position: "top-end",
        iconColor: "white",
        customClass: {
            popup: "colored-toast",
        },
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
    });

    var selectedProduct, selectedProductDetailId, selectedProductDetailColor, selectedProductDetailSize;
    var productDetail;
    var chooseColor, chooseSize = [];
    window.onload = function () {
        loadPage(0);
        chooseColor = [];
        chooseSize = [];
    }


    async function loadPage(pageNumber) {
        var priceMax = "/api/client/product/priceMax";
        const responsePriceMax = await fetch(priceMax, {
            method: 'GET',
        });
        var resultPriceMax = await responsePriceMax.json();
        var url = "/api/client/product/page/" + pageNumber + "/" + 0 + "/" + resultPriceMax + "?sort=" + 0;
        var request = requestConfig(chooseColor, chooseSize);
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        });
        var result = await response.json();
        var list = result.content;
        var main = '';
        var color = '';
        var labelColor = '';
        var cssStyle = '';
        var size = '';
        var index;
        for (i = 0; i < list.length; i++) {
            var urlDetailPD = '/api/client/product_detail/detailPD/' + list[i].id;
            const responseDetailPD = await fetch(urlDetailPD, {
                method: 'GET'
            });
            const data = await responseDetailPD.json();
            let resultDetailColor = data.filter((product, index, self) =>
                index === self.findIndex((p) => (
                    p.ms.id === product.ms.id
                ))
            );
            // Sort colors based on ms.id
            resultDetailColor.sort((a, b) => a.ms.id - b.ms.id);
            index = i;
            for (j = 0; j < resultDetailColor.length; j++) {
                if (list[i].id === resultDetailColor[j].sp.id) {
                    var name = resultDetailColor[j].ms.id;
                    if (resultDetailColor[j].ms.id === 1) {
                        labelColor = "btn-dark";
                        cssStyle = "";
                    } else if (resultDetailColor[j].ms.id === 2) {
                        cssStyle = "";
                        labelColor = "btn-light";
                    } else if (resultDetailColor[j].ms.id === 3) {
                        cssStyle = "";
                        labelColor = "btn-danger";
                    } else if (resultDetailColor[j].ms.id === 4) {
                        labelColor = "btn-secondary";
                        cssStyle = "style=\"background-color: rgb(169,169,169); border: none;\"";
                    } else if (resultDetailColor[j].ms.id === 5) {
                        cssStyle = "";
                        labelColor = "btn-success";
                    } else if (resultDetailColor[j].ms.id === 6) {
                        cssStyle = "";
                        labelColor = "btn-secondary";
                    } else if (resultDetailColor[j].ms.id === 7) {
                        cssStyle = "";
                        labelColor = "btn-primary";
                    } else {
                        cssStyle = "";
                        labelColor = "btn-warning";
                    }
                    color += `<li><input type="radio" value="${name}" name="product-color" id="product-color-${index}${name}" onclick="chooseProductColor(${list[i].id},${index},${name},${j + 1})"><label class="avatar-xxs btn ${labelColor} p-0 d-flex align-items-center justify-content-center rounded-circle" for="product-color-${index}${name}" ${cssStyle}></label></li>`
                }
            }
            let resultDetailSize = data.filter((product, index, self) =>
                index === self.findIndex((p) => (
                    p.size === product.size
                ))
            );
            // Sort sizes based on size
            resultDetailSize.sort((a, b) => a.size.localeCompare(b.size));
            for (j = 0; j < resultDetailSize.length; j++) {
                if (list[i].id === resultDetailSize[j].sp.id) {
                    var name = resultDetailSize[j].size;
                    size += `<li data-value="${name}" class="li-size${list[i].id}"><input class="size-input${list[i].id}"  disabled type="radio" value="${name}" name="product-size" id="product-size-${index}${j + 1}" onclick="chooseProductSize(${list[i].id},${index},${j + 1})"><label class="avatar-xxs btn btn-soft-primary p-0 d-flex align-items-center justify-content-center rounded-circle" for="product-size-${index}${j + 1}" >${resultDetailSize[j].size}</label></li>`
                }
            }
            main += ` <div class="col item">
                <div class="card product-widget border-0 card-animate">
                    <div class="card-body p-2">
                        <div class="position-relative p-4 bg-light">
                            <img src="../assets/images/fashion/product/img-02.png" alt=""
                                 class="img-fluid product-img-main">
                            <img src="../assets/images/fashion/product/img-17.png" alt=""
                                 class="img-fluid product-img-2">
                            <ul class="product-menu list-unstyled">
                                <li>
                                    <a onclick="nextPageProductDetail(${list[i].id})" class="rounded-circle"><i
                                            class="bi bi-eye"></i></a>
                                </li>
                            </ul>
                            <div class="product-btn mx-auto">
                             <div class="mt-3">
                            <div class="hstack gap-2">
                                <button type="button" class="btn btn-success btn-hover w-100"><i class="bi bi-bag align-baseline me-1"></i>
                                    Buy Now
                                </button>
                                <button type="button" class="btn btn-primary btn-hover w-100" onclick="AddToCart()">
                                    <i class="bi bi-cart2 me-2"></i>Add To Cart
                                </button>
                            </div>
                        </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="#!">
                                <h6 class="text-capitalize fs-16 text-truncate">${list[i].tenSP}</h6>
                            </a>
                            <h6 class="fw-normal mb-3 fs-16">${formatMoney(list[i].donGia)}</h6>
                            <ul class="clothe-colors list-unstyled hstack gap-1 mb-auto flex-wrap" style="height: 35px">${color}</ul>
                            <ul class="clothe-size list-unstyled hstack gap-1 mb-auto flex-wrap" style="height: 35px">${size}</ul>
                        </div>
                    </div>
                </div>
            </div>`
            color = '';
            size = '';
        }
        document.getElementById("productList").innerHTML = main;
    }

    async function chooseProductColor(idPD, indexId, id) {
        var url = "/api/client/product_detail/detail/" + idPD + "/" + id;
        var arrSize = [];
        var liSize = document.querySelectorAll('li.li-size' + idPD);
        var inputSize = document.querySelectorAll('input.size-input' + idPD);
        const response = await fetch(url, {
            method: 'GET'
        });
        var result = await response.json();
        if (selectedProduct === undefined && selectedProductDetailColor === undefined) {
            arrSize = [];
            selectedProduct = idPD;
            selectedProductDetailColor = id;
            for (i = 0; i < result.length; i++) {
                inputSize.forEach(function (inputs) {
                    var a = inputs.value.toLowerCase();
                    var b = result[i].size.toLowerCase();
                    if (b === a) {
                        inputs.removeAttribute('disabled');
                        arrSize.push(inputs.value);
                    }
                });
            }
        } else {
            if (selectedProduct === idPD && selectedProductDetailColor !== id) {
                arrSize = [];
                selectedProductDetailColor = id;
                selectedProductDetailSize = undefined;
                for (i = 0; i < result.length; i++) {
                    inputSize.forEach(function (inputs) {
                        var a = inputs.value.toLowerCase();
                        var b = result[i].size.toLowerCase();
                        if (b === a) {
                            inputs.checked = false;
                            inputs.removeAttribute('disabled');
                            arrSize.push(inputs.value);
                        }
                    });
                }
            } else {
                var radioInputs = document.querySelectorAll('input[type="radio"]');
                var idToRemove = "product-color-" + indexId + id;
                for (var i = 0; i < radioInputs.length; i++) {
                    if (radioInputs[i].id === idToRemove) {
                        // Loại bỏ checked = false cho các phần tử radio trừ phần tử hiện tại
                        for (var j = 0; j < radioInputs.length; j++) {
                            if (j !== i) {
                                radioInputs[j].checked = false;
                            }
                        }
                        break;
                    }
                }
                selectedProduct = idPD;
                selectedProductDetailColor = id;
                arrSize = [];
                for (i = 0; i < result.length; i++) {
                    inputSize.forEach(function (inputs) {
                        var a = inputs.value.toLowerCase();
                        var b = result[i].size.toLowerCase();
                        if (b === a) {
                            inputs.removeAttribute('disabled');
                            arrSize.push(inputs.value);
                        }
                    });
                }
            }
        }

        liSize.forEach(function (li) {
            var a = li.dataset.value.toLowerCase();
            var matchFound = false;
            for (i = 0; i < arrSize.length; i++) {
                var b = arrSize[i].toLowerCase();
                if (a === b) {
                    matchFound = true;
                    break;
                }
            }
            if (!matchFound) {
                li.style.display = 'none';
            } else {
                li.style.display = 'block';
            }
        });
    }

    function chooseProductSize(idPD, indexId, id) {
        //lưu size selectSize
        selectedProduct = idPD;
        var nameSize = document.getElementById('product-size-' + indexId + id);
        selectedProductDetailSize = nameSize.value;
    }

    function requestConfig(arrColor, arrSize) {
        let filterRequest = {};
        if (arrColor.length === 0 && arrSize.length !== 0) {
            console.log(arrColor);
            filterRequest = {listColors: null, listSizes: arrSize};
        } else if (arrColor.length !== 0 && arrSize.length === 0) {
            console.log(arrSize);
            filterRequest = {listColors: arrColor, listSizes: null};
        } else if (arrColor.length === 0 && arrSize.length === 0) {
            console.log(arrColor, arrSize);
            filterRequest = {listColors: null, listSizes: null};
        } else {
            console.log(arrColor, arrSize);
            filterRequest = {listColors: arrColor, listSizes: arrSize};
        }
        return filterRequest;
    }

    async function AddToCart() {
        let product = {};
        if (selectedProductDetailColor === undefined && selectedProductDetailSize === undefined) {
            (async () => {
                await Toast.fire({
                    icon: "warning",
                    title: "Chưa Chọn Màu Và Size !",
                });
            })();
        } else if (selectedProductDetailColor === undefined) {
            (async () => {
                await Toast.fire({
                    icon: "warning",
                    title: "Chưa Chọn Màu !",
                });
            })();
        } else if (selectedProductDetailSize === undefined) {
            (async () => {
                await Toast.fire({
                    icon: "warning",
                    title: "Chưa Chọn Màu !",
                });
            })();
        } else {
            product = {idSP: selectedProduct, ms: selectedProductDetailColor, size: selectedProductDetailSize};
            var url = '/api/client/cart_detail/add';
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(product)
            });
            console.log(response);
            if (response.status === 200) {
                (async () => {
                    await Toast.fire({
                        icon: "success",
                        title: "Thêm thành công!",
                    });
                })();
            } else {
                (async () => {
                    await Toast.fire({
                        icon: "error",
                        title: "Thêm thất bại!",
                    });
                })();
            }
        }
    }

    function formatMoney(money) {
        const VND = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });
        return VND.format(money);
    }

    function nextPageProduct() {
        window.location.href = '/client/product';
    }

    function nextPageProductDetail(id) {
        window.location.href = '/client/product/detail/' + id;
    }

</script>
</body>
</html>